<template>
    <div>
        <modal v-show="showPlatformModal === true" :open="showPlatformModal" @close-modal="() => {showPlatformModal = false;}" class="z-max z-top">
            <template v-slot:title>
                <p class='card-header-title'>{{ $t('GameSelectionScreen.storeSelection.title') }}</p>
            </template>
            <template v-slot:body>
                <p>{{ $t('GameSelectionScreen.storeSelection.label') }}</p>
                <div v-if="selectedGame !== null">
                    <div v-for="(platform, index) of selectedGame.storePlatformMetadata" :key="`${index}-${platform.storePlatform.toString()}`">
                        <input type="radio" :id="`${index}-${platform.storePlatform.toString()}`" :value="platform.storePlatform" v-model="selectedPlatform"/>
                        <label :for="`${index}-${platform.storePlatform.toString()}`">&nbsp;{{ platform.storePlatform }}</label>
                    </div>
                </div>
            </template>
            <template v-slot:footer>
                <button class='button is-info' @click='selectPlatform'>
                    {{ $t('GameSelectionScreen.storeSelection.confirm') }}
                </button>
            </template>
        </modal>
        <hero
            :title="`${$t('GameSelectionScreen.hero.title')}`"
            :subtitle="`${$t('GameSelectionScreen.hero.subtitle')}`"
            heroType="is-info"
        />
        <div class="notification is-warning is-square" v-if="runningMigration">
            <div class="container">
                <p>{{ $t('R2Modman.runningMigration.needBackgroundWork') }}</p>
                <p>{{ $t('R2Modman.runningMigration.gameSelectSoon') }}</p>
            </div>
        </div>
        <div class="columns">
            <div class="column is-full">
                <br/>

                <div class="sticky-top is-shadowless background-bg z-top">
                    <div class="container" v-if="viewMode === 'Card'">
                        <nav class="level">
                            <div class="level-item">
                                <div class="card-header-title">
                                    <div class="input-group input-group--flex margin-right">
                                        <label for="local-search" class="non-selectable">{{ $t('GameSelectionScreen.search.label') }}</label>
                                        <input id="local-search" v-model='filterText' class="input margin-right" type="text" :placeholder="`${ $t('GameSelectionScreen.search.placeholder') }`"/>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <br/>
                                <i class="button fas fa-list" @click="toggleViewMode"></i>
                            </div>
                        </nav>
                        <div class="level">
                            <div class="level-item">
                                <div class="tabs">
                                    <ul class="text-center">
                                        <li v-for="(key, index) in gameInstanceTypes" :key="`tab-${key}`"
                                            :class="[{'is-active': activeTab === key}]">
                                            <a @click="changeTab(key)">{{key}}</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="container" v-else-if="viewMode === 'List'">
                        <nav class="level">
                            <div class="level-item">
                                <div class="card-header-title">
                                    <div class="input-group input-group--flex margin-right">
                                        <label for="local-search" class="non-selectable">{{ $t('GameSelectionScreen.search.label') }}</label>
                                        <input id="local-search" v-model='filterText' class="input margin-right" type="text" :placeholder="`${ $t('GameSelectionScreen.search.placeholder') }`"/>
                                    </div>
                                </div>
                            </div>
                            <div class="margin-right">
                                <br/>
                                <a class="button is-info"
                                   :disabled="selectedGame === null && !this.runningMigration"
                                   @click="selectGame(selectedGame)"
                                   >
                                   {{ $t('GameSelectionScreen.buttons.confirm') }}
                                   </a>
                            </div>
                            <div class="margin-right">
                                <br/>
                                <a class="button"
                                   :disabled="selectedGame === null && !this.runningMigration" @click="selectDefaultGame(selectedGame)">{{ $t('GameSelectionScreen.buttons.makeDefault') }}</a>
                            </div>
                            <div>
                                <br/>
                                <i class="button fas fa-th-large" @click="toggleViewMode"></i>
                            </div>
                        </nav>
                        <div class="level">
                            <div class="level-item">
                                <div class="tabs">
                                    <ul class="text-center">
                                        <li v-for="(key, index) in gameInstanceTypes" :key="`tab-${key}`"
                                            :class="[{'is-active': activeTab === key}]">
                                            <a @click="changeTab(key)">{{key}}</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container">
                    <article class="media">
                        <div class="media-content">
                            <div class="content pad--sides" v-if="viewMode === 'Card'">
                                <h1 class="title is-4">{{ activeTab }}s</h1>
                                <div>
                                    <div v-for="(game, index) of filteredGameList" :key="`${index}-${game.displayName}-${selectedGame === game}-${isFavourited(game)}`" class="inline-block margin-right margin-bottom">

                                        <div class="inline">
                                            <div class='card is-shadowless'>
                                                <div class='cursor-pointer'>
                                                    <header class='card-header is-shadowless is-relative'>
                                                        <div class="absolute-full z-fab flex">
                                                            <div class="card-action-overlay rounded">
                                                                <div class="absolute-top card-header-title">
                                                                    <p class="text-left title is-5 has-text-white">{{ game.displayName }}</p>
                                                                </div>
                                                                <div class="absolute-top-right card-header-title">
                                                                    <p class="text-left title is-5">
                                                                        <a :id="`${game.settingsIdentifier}-star`" href="#" @click.prevent="toggleFavourite(game)">
                                                                            <i class="fas fa-star text-warning" v-if="favourites.includes(game.settingsIdentifier)"></i>
                                                                            <i class="far fa-star" v-else></i>
                                                                        </a>
                                                                    </p>
                                                                </div>
                                                                <div class="absolute-center text-center">
                                                                    <button class="button is-info" @click="selectGame(game)" :class="[{'is-disabled': selectedGame === null}]">{{ $t('GameSelectionScreen.buttons.confirm') }}</button>
                                                                    <br/><br/>
                                                                    <button class="button" @click="selectDefaultGame(game)">{{ $t('GameSelectionScreen.buttons.makeDefault') }}</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="image is-fullwidth border border--border-box rounded" :class="[{'border--warning warning-shadow': isFavourited(game)}]">
                                                            <img :src='getImage(game.gameImage)' alt='Mod Logo' class="rounded"/>
                                                        </div>
                                                    </header>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <div class="content" v-if="viewMode === 'List'">
                                <div v-for="(game, index) of filteredGameList" :key="`${index}-${game.displayName}-${selectedGame === game}-${isFavourited(game)}`">
                                    <a @click="selectedGame = game">
                                        <div class="border-at-bottom cursor-pointer">
                                            <div class="card is-shadowless">
                                                <p
                                                    :class="['card-header-title', {'has-text-info':selectedGame === game}]"
                                                >
                                                    <a :id="`${game.settingsIdentifier}-star`" href="#" class="margin-right" @click.prevent="toggleFavourite(game)">
                                                        <i class="fas fa-star text-warning" v-if="favourites.includes(game.settingsIdentifier)"></i>
                                                        <i class="far fa-star" v-else></i>
                                                    </a>
                                                    {{ game.displayName }}
                                                </p>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                                <br/>
                            </div>
                        </div>
                    </article>
                </div>
            </div>
        </div>
    </div>
</template>

<script lang="ts">
import { Component, Vue } from 'vue-property-decorator';
import Game from '../model/game/Game';
import GameManager from '../model/game/GameManager';
import Hero from '../components/Hero.vue';
import FolderMigration from '../migrations/FolderMigration';
import PathResolver from '../r2mm/manager/PathResolver';
import * as path from 'path';
import FileUtils from '../utils/FileUtils';
import ManagerSettings from '../r2mm/manager/ManagerSettings';
import { StorePlatform } from '../model/game/StorePlatform';
import { GameSelectionDisplayMode } from '../model/game/GameSelectionDisplayMode';
import { GameSelectionViewMode } from '../model/enums/GameSelectionViewMode';
import PlatformInterceptorProvider from '../providers/generic/game/platform_interceptor/PlatformInterceptorProvider';
import GameRunnerProvider from '../providers/generic/game/GameRunnerProvider';
import GameDirectoryResolverProvider from '../providers/ror2/game/GameDirectoryResolverProvider';
import R2Error from '../model/errors/R2Error';
import Modal from '../components/Modal.vue';
import { GameInstanceType } from '../model/game/GameInstanceType';

@Component({
    components: {
        Hero,
        Modal
    }
})
export default class GameSelectionScreen extends Vue {

    private runningMigration = false;
    private selectedGame: Game | null = null;
    private filterText: string = "";
    private showPlatformModal: boolean = false;
    private selectedPlatform: StorePlatform | null = null;
    private favourites: string[] = [];
    private settings: ManagerSettings | undefined;
    private isSettingDefaultPlatform: boolean = false;
    private viewMode = GameSelectionViewMode.LIST;
    private activeTab = GameInstanceType.GAME;

    get gameInstanceTypes(): string[] {
        return Object.values(GameInstanceType);
    }

    get filteredGameList() {
        return this.gameList
            .filter(value => value.displayName.toLowerCase().indexOf(this.filterText.toLowerCase()) >= 0 || this.filterText.trim().length === 0)
            .filter(value => value.displayMode === GameSelectionDisplayMode.VISIBLE)
            .filter(value => value.instanceType === this.activeTab);
    }

    get gameList(): Game[] {
        return GameManager.gameList.sort((a, b) => {
            if (this.favourites.includes(a.settingsIdentifier)) {
                if (this.favourites.includes(b.settingsIdentifier)) {
                    return a.displayName.toLowerCase().localeCompare(b.displayName.toLowerCase());
                } else {
                    return -1;
                }
            } else if (this.favourites.includes(b.settingsIdentifier)) {
                return 1;
            }
            return a.displayName.toLowerCase().localeCompare(b.displayName.toLowerCase());
        });
    }

    private changeTab(key: string) {
        for (const objKey of Object.keys(GameInstanceType)) {
            if ((GameInstanceType as any)[objKey] === key) {
                this.activeTab = (GameInstanceType as any)[objKey];
            }
        }
    }

    private selectGame(game: Game) {
        this.selectedGame = game;
        this.isSettingDefaultPlatform = false;
        if (game.storePlatformMetadata.length > 1) {
            this.selectedPlatform = null;
            this.showPlatformModal = true;
        } else {
            this.selectedPlatform = game.storePlatformMetadata[0].storePlatform;
            this.showPlatformModal = false;
            this.proceed();
        }
    }

    private selectDefaultGame(game: Game) {
        this.selectedGame = game;
        this.isSettingDefaultPlatform = true;
        if (game.storePlatformMetadata.length > 1) {
            this.showPlatformModal = true;
        } else {
            this.selectedPlatform = game.storePlatformMetadata[0].storePlatform;
            this.showPlatformModal = false;
            this.proceedDefault();
        }
    }

    private selectPlatform() {
        if (this.isSettingDefaultPlatform) {
            this.proceedDefault()
        } else {
            this.proceed();
        }
    }

    private async proceed() {
        if (this.selectedGame !== null && !this.runningMigration && this.selectedPlatform !== null) {
            GameManager.activeGame = this.selectedGame;
            GameManager.activeGame.setActivePlatformByStore(this.selectedPlatform);
            PathResolver.MOD_ROOT = path.join(PathResolver.ROOT, this.selectedGame.internalFolderName);
            await FileUtils.ensureDirectory(PathResolver.MOD_ROOT);

            const settings = await ManagerSettings.getSingleton(this.selectedGame);
            await settings.setLastSelectedGame(this.selectedGame);

            const gameRunner = PlatformInterceptorProvider.instance.getRunnerForPlatform(this.selectedPlatform);
            if (gameRunner === undefined) {
                this.$emit("error", new R2Error("No suitable runner found", "Runner is likely not yet implemented.", null));
                return;
            }
            GameRunnerProvider.provide(() => gameRunner);

            const directoryResolver = PlatformInterceptorProvider.instance.getDirectoryResolverForPlatform(this.selectedPlatform);
            if (directoryResolver === undefined) {
                this.$emit("error", new R2Error("No suitable resolver found", "Resolver is likely not yet implemented.", null));
                return;
            }
            GameDirectoryResolverProvider.provide(() => directoryResolver);

            await this.$router.replace('/splash');
        }
    }

    private async proceedDefault() {
        if (this.selectedGame !== null && !this.runningMigration && this.selectedPlatform !== null) {
            GameManager.activeGame = this.selectedGame;
            GameManager.activeGame.setActivePlatformByStore(this.selectedPlatform);
            PathResolver.MOD_ROOT = path.join(PathResolver.ROOT, this.selectedGame.internalFolderName);
            await FileUtils.ensureDirectory(PathResolver.MOD_ROOT);
            const settings = await ManagerSettings.getSingleton(this.selectedGame);
            await settings.setLastSelectedGame(this.selectedGame);
            await settings.setDefaultGame(this.selectedGame);
            await settings.setDefaultStorePlatform(this.selectedPlatform);

            const gameRunner = PlatformInterceptorProvider.instance.getRunnerForPlatform(this.selectedPlatform);
            if (gameRunner === undefined) {
                this.$emit("error", new R2Error("No suitable runner found", "Runner is likely not yet implemented.", null));
                return;
            }
            GameRunnerProvider.provide(() => gameRunner);

            const directoryResolver = PlatformInterceptorProvider.instance.getDirectoryResolverForPlatform(this.selectedPlatform);
            if (directoryResolver === undefined) {
                this.$emit("error", new R2Error("No suitable resolver found", "Resolver is likely not yet implemented.", null));
                return;
            }
            GameDirectoryResolverProvider.provide(() => directoryResolver);

            await this.$router.replace('/splash');
        }
    }

    private toggleFavourite(game: Game) {
        if (this.favourites.includes(game.settingsIdentifier)) {
            this.favourites = this.favourites.filter(value => value !== game.settingsIdentifier)
        } else {
            this.favourites = [...this.favourites, game.settingsIdentifier];
        }
        if (this.settings !== undefined) {
            this.settings.setFavouriteGames(this.favourites);
        }
    }

    isFavourited(game: Game) {
        if (this.settings !== undefined) {
            return this.favourites.includes(game.settingsIdentifier);
        }
    }

    created() {
        const self = this;
        this.runningMigration = true;
        FolderMigration.needsMigration()
            .then(isMigrationRequired => {
                if (!isMigrationRequired) {
                    this.runningMigration = false;
                } else {
                    return FolderMigration.runMigration();
                }
            })
            .then(() => {
                this.runningMigration = false;
            })
            .catch((e) => {
                console.log(e);
                this.runningMigration = false;
            })
        .finally(() => {
            ManagerSettings.getSingleton(GameManager.unsetGame()).then(settings => {
                const lastSelectedGame = settings.getContext().global.lastSelectedGame;
                const savedViewMode = settings.getContext().global.gameSelectionViewMode;
                switch (savedViewMode) {
                    case "List": this.viewMode = GameSelectionViewMode.LIST; break;
                    case "Card":
                    case undefined:
                        this.viewMode = GameSelectionViewMode.CARD;
                        break;
                }
                if (lastSelectedGame !== null) {
                    const game = GameManager.gameList.find(value => value.internalFolderName === lastSelectedGame);
                    if (game !== undefined) {
                        this.selectedGame = game;
                    }
                }
            });
            ManagerSettings.getSingleton(GameManager.unsetGame()).then(value => {
                this.settings = value;
                this.favourites = value.getContext().global.favouriteGames || [];
                if (value.getContext().global.defaultGame !== undefined) {
                    if (value.getContext().global.defaultStore !== undefined) {
                        const game = GameManager.gameList
                            .find(value1 => value1.internalFolderName === value.getContext().global.defaultGame)!;

                        const platform = game.storePlatformMetadata.find(value1 => value1.storePlatform === value.getContext().global.defaultStore)!;

                        this.selectedGame = game;
                        this.selectedPlatform = platform.storePlatform;

                        this.proceed();
                        return;
                    }
                }
            });
        })
    }

    toggleViewMode() {
        if (this.viewMode === "List") {
            this.viewMode = GameSelectionViewMode.CARD;
        } else {
            this.viewMode = GameSelectionViewMode.LIST;
        }
        if (this.settings !== undefined) {
            this.settings.setGameSelectionViewMode(this.viewMode);
        }
    }

    getImage(image: string) {
        return require("../assets/images/game_selection/" + image);
    }

}
</script>
